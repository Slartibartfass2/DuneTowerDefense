name: Test report

on:
  workflow_run:
    workflows: [Code Quality Checks]
    types:
      - completed

jobs:
  test-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Report test results
        id: test-results
        uses: dorny/test-reporter@v1.6.0
        with:
          artifact: test-artifacts
          name: JUnit Tests
          path: test-results/test/*.xml
          reporter: java-junit

      - name: Get the test result info
        run: |
          echo "Conclusion: ${{ steps.test-results.outputs.conclusion }}"
          echo "Passed: ${{ steps.test-results.outputs.passed }}"
          echo "Failed: ${{ steps.test-results.outputs.failed }}"
          echo "Skipped: ${{ steps.test-results.outputs.skipped }}"

      - name: Add coverage to PR
        id: jacoco
        uses: madrapps/jacoco-report@v1.3
        with:
          paths: ${{ github.workspace }}/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          title: JaCoCo Coverage
          update-comment: true

      - name: Get the coverage info
        run: |
          echo "Total coverage: ${{ steps.jacoco.outputs.coverage-overall }}"
          echo "Changed Files coverage: ${{ steps.jacoco.outputs.coverage-changed-files }}"
